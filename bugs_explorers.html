<!DOCTYPE html> 
<html lang="en">  
 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="viewport" content="width=device-width, minimum-scale=1.0" />
<meta name="description" content="Explorers" />
<link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link rel="shortcut icon" href="favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="Explorers" />
<link rel="manifest" href="fish.webmanifest" />
<link rel="stylesheet" type="text/css" href="seed_library.css" />
<script type="text/javascript" src='common_func.js'> </script>
<title>Explorers</title>
</head>

<body>
<script>
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
let winurlparams = new URLSearchParams(winurlsearchstr.substring(1));
let p_garden     = winurlparams.get('garden') || '';
let p_params     = winurlparams.get('params') || '';
let p_project_id = winurlparams.get('project_id') || '';
let p_plant_name = winurlparams.get('plant_name') || '';
let p_mode       = winurlparams.get('mode' || 'explorers');
let p_seed_prj   = winurlparams.get('seed_project' || '');
let p_place_id   = '';
let p_user = '';
 
// don't show organsims that have only been id'd to genus and above, otherwise the number's
// won't match other counts
//winurlparams.append('hrank', 'species');
 
// cache check of session storage to make app less expensive to server (cache check, get it!  bwahahaha)
// session storage is only used for sorting of data in columns at this point.
let p_cache_check = winurlparams.get('cache_check') || 'no';  

let configs = '';
let seed_prj_param = '';

// if the user has selected a method, built the opt to pass to the
// lifelist page.
let p_field = '';
let p_field_opt = '';
let p_field_value = '';
// find key/value pair for &field: param if one was passed in
for (const [key, value] of winurlparams.entries()) {
  if( key.startsWith('field') ){
      p_field_value = value;
      p_field = ('&'+key+'=');
      p_field_opt = ('&'+key+'='+value);
  }
}   
 
let view = winurlparams.get('view') || '';
let activity_data = winurlparams.get('activity_data') || 'local';
winurlparams.delete('activity_data');
</script>
   
<script src="https://cdn.jsdelivr.net/gh/stockslager/inat/rewild_common_func_v2.js"></script>
<script src="https://cdn.jsdelivr.net/gh/stockslager/inat/library_params_v7.js"></script>

<script>

function furlArrow(url,txt=url) { return '<a href="'+url+'" id="arrow">'+txt+'</a>'; };

function findValueByKey(arr, key, value) {
  for (let i = 0; i < arr.length; i++) {
    if (arr[i][key].toString() === value) {
      return arr[i];
    }
  }
  return undefined;
}

function setUpDefaults(configurations) {

   if( configurations.length === 0 ) {
       faddelem('p',document.body,{innerText:'Configuration file ('+p_params+'.json) contains no valid configurations.'});
       faddelem('p',document.body,{innerText:'There are no configurations specified in '+p_params+'.json'});
       faddelem('p',document.body,{innerText:'Please add at least one valid configuration to '+p_params+'.json'});
       throw new Error('No configurations defined.');
   }
 
   // if a garden wasn't passed in, default to the first configuration in the .json
   for( let i=0; i<configurations.length; i++ ) {
        if( configurations[i].insect_project === p_project_id ) {
            configuration = configurations[i];
        }
   }
        
   if( !configuration ) {
       faddelem('p',document.body,{innerText:'An insect_project parameter was not specified in '+p_param+'.json.'});
       faddelem('p',document.body,{innerText:'Please modify '+p_params+'.json to include an insect_project.'});
       throw new Error('No configurations defined.');
   }

   if( configuration.field_name ) {
       winurlparams.append( ('field:'+configuration.field_name), '');
   }

   if( configuration.apply_project_rules_for ) {
       winurlparams.append( 'apply_project_rules_for', configuration.apply_project_rules_for );
   }

   // if a project id was not passed in and there is an insect_project specified in the configuration,
   // default the project id to the insect_project.
   if( !p_project_id ) {
       if( configuration.insect_project ) {
           winurlparams.delete('project_id');
           winurlparams.append('project_id', configuration.insect_project);
           p_project_id = configuration.insect_project;
       }
   }

   // if no place id was passed in and there's a default place in the configuration,
   // set the p_place_id to the default.
   if( !p_place_id && configuration.default_place ) {
       p_place_id = configuration.default_place;
   }

   // if no user id was passed in and there's a default user in the configuration,
   // set the p_user to the default.
   if( !p_user && configuration.user_id ) {
       p_user = configuration.user_id;
   }

   if( !p_seed_prj ) {
       seed_prj_param += ('&seed_project=exp'+p_project_id);
       if( p_place_id ) { seed_prj_param += '$'+p_place_id; } else { seed_prj_param += '$null'; }
       if( p_params )   { seed_prj_param += '$'+p_params;   } else { seed_prj_param += '$null'; }
       if( p_user )     { seed_prj_param += '$'+p_user;     } else { seed_prj_param += '$null'; }
       if( p_garden )   { seed_prj_param += '$'+p_garden;   } else { seed_prj_param += '$null'; }
       if( p_mode )     { seed_prj_param += '$'+p_mode;     } else { seed_prj_param += '$null'; }
       p_seed_prj = seed_prj_param;
   }
 
}

function buildMenu(configs) {
      let menu_string = '';
      let garden_links = '';
      let params = '';
      let choose_plant = 'Choose Plant';

      if( p_params )         { params      += '?params=' + p_params; }   
      if( p_seed_prj )       { params      += '&seed_project=' + p_seed_prj; }

      menu_string = '<div class="navbar">';

      menu_string += furl(github_root+'bugs_on_plants.html'+params+'&mode='+p_mode, choose_plant);

      if( p_mode.startsWith('pro') ) {
          menu_string += buildHome(furl(github_root+'bugs_dash.html?params='+p_params,'&#127807;'));
      }
 
      menu_string += '</div>';

      faddelem('p',document.body,{innerHTML:(menu_string)});  
}
 
function fresults(result, places_obj, taxa_obj) {

   if (result) {

      let total_results = result.total_results;
      let per_page = result.per_page;
      let page_curr = result.page;
      let page_max = Math.ceil(total_results/per_page);
      let page_prev = ((page_curr>1)?page_curr-1:null);
      let page_next = ((page_curr<page_max)?page_curr+1:null);

      let on_all = '';
      let on_all2 = '';
    
      if( !p_plant_name ) {
          on_all = '<span id="topright">showing counts for<br> <b>' +
                   'all plants</b></span>';
                   //+ furl(github_root+'bugs_on_plants2.html?project_id='+configuration.insect_project+'&params='+p_params+p_field_opt+'&title=on'+seed_prj_param,' any plant') 
                   //+ '</b><br>by any user</span>';
      } else {
          on_all2 = '<span id="topright">showing counts for<br><b>'+p_plant_name.toLowerCase()+'</b>' +
                   '<br>show ' +
                   furl(github_root+'bugs_explorers.html?project_id='+configuration.insect_project+'&params='+p_params+p_field+p_seed_prj+'&mode='+p_mode,'all plants?') + '</span>';
      }
    
      faddelem('p',document.body,{innerHTML:'project members: '+fcomnum(total_results) + on_all2 + '<br />' 
            +'per page: '+fcomnum(per_page)+ on_all + '<br />'
            +'page: '+fcomnum(page_curr)+' of '+fcomnum(page_max)+'<br />'
            });

      let table = faddelem('table',document.body,{id:'main'});
      let thead = faddelem('thead',table);
      let hrow = faddelem('tr',thead);

      let labels = [
         {innerText:'#'},
         {innerText:'Icon '},
         {innerText:'User' },
         {innerText:'Species'  },
         //{innerText:'Obs'  },
      ];
      faddelems('th',hrow,labels);
      
      let tbody = faddelem('tbody',table);
      for (let i=0; i<result.recs.length; i++) {
         let target_url = '';     
         let brow = faddelem('tr',tbody);
         let rec = result.recs[i];
         let lists = '';
         let user_icon = rec.icon || '';
         
         if( user_icon === '' ){
            user_icon += '<div class="npcicon"></div>';
         } else {
            user_icon = '<img class="exp_icon" src="'+user_icon+'" />';
         }

         let params = '';
         if( p_params )         { params      += '&params=' + p_params; }   
         if( p_seed_prj )       { params      += p_seed_prj }

         let values = [
            {innerText:i+1},
            {innerHTML:user_icon},
            {innerHTML:furl(root_people+rec.user_login,rec.user_login)/*+map*/},
            {innerHTML:furl(github_root+'bugs_on_plants2.html?project_id='+configuration.insect_project+'&user_id='+rec.user_login+params+p_field_opt+'&title=on&target_name='+p_plant_name,rec.species_count )},
            //{innerHTML:furl(github_root+'bugs_on_plants_grid.html?project_id='+p_project_id+params+'&user_id='+rec.user_login+p_field_opt,rec.obs_count)},
         ];
         faddelems('td',brow,values);
      };

      // buttons to go to prev or next page
      let nav = faddelem('div',document.body,{id:'nav'});
      (page_curr<=1)?faddelem('span',nav,{classList:'button_inactive',title:'already on first page',innerHTML:'&laquo'}):faddelem('a',nav,{classList:'button',title:'first page',id:'button_first',innerHTML:'&laquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,1)});
      (page_prev===null)?faddelem('span',nav,{classList:'button_inactive',title:'no previous page',innerHTML:'&#8249'}):faddelem('a',nav,{classList:'button',title:'previous page',id:'button_prev',innerHTML:'&#8249',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_prev)});
      (page_next===null)?faddelem('span',nav,{classList:'button_inactive',title:'no next page',innerHTML:'&#8250'}):faddelem('a',nav,{classList:'button',title:'next page',id:'button_next',innerHTML:'&#8250',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_next)});
      (page_curr>=page_max)?faddelem('span',nav,{classList:'button_inactive',title:'already on last page',innerHTML:'&raquo'}):faddelem('a',nav,{classList:'button',title:'last page',id:'button_last',innerHTML:'&raquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_max)});
   }
   else { faddelem('p',document.body,{innerText:'No results returned.'}); };
};

class Result {
  constructor(total_results, per_page, page, recs) {
    this.total_results = total_results;
    this.per_page = per_page;
    this.page = page;
    this.recs = recs;
  }
}

class Record {
  constructor(count, icon, user_login, species_count, obs_count) {
    this.count = count;
    this.icon = icon;
    this.user_login = user_login;
    this.species_count = species_count;
    this.obs_count = obs_count;
  }
}
  
function storeData(xobj) {
   let results = xobj.results;

   if (results) {
      let record_array = [];
      for( let i=0; i<results.length; i++ ) {
           const record = new Record((i+1), results[i].user.icon, results[i].user.login, results[i].species_count, results[i].observation_count);
           record_array.push(record);
      }
      const result = new Result( xobj.total_results, xobj.per_page, xobj.page, JSON.stringify(record_array) );

      // Serialize the object to JSON string so it can be stored in session
      const result_string = JSON.stringify(result);
      sessionStorage.setItem('gardeners', result_string);
   }
   else { faddelem('p',document.body,{innerText:'No results returned.'}); };
}

function parseStoredData(gardeners) {
   // Check if value exists before parsing
   if( gardeners ) {
       // Parse the string back to an object
       const retrievedRec = JSON.parse(gardeners);
       retrievedRec.recs = JSON.parse(retrievedRec.recs);
       return retrievedRec;
   } else {
       console.log("No object found in session storage for key 'myObject'");
       throw new Error("No object found in session storage.");
   }
}

let apibase = 'https://api.inaturalist.org/v1/observations/observers';
let apiurl = apibase+((winurlparams!='')?('?'+winurlparams):'');
let apirefurl = 'https://api.inaturalist.org/v1/observations/observers';
let apirefname = 'iNaturalist Angling Life Lists';
let apiref = furl(apirefurl,apirefname);

async function asyncGetData() {
   await fetch(p_params+'.json')
     .then(response => response.json())
     .then(data => {
           console.log('setting up defaults...');
           setUpDefaults(data.configurations);
           console.log('building menu...');
           buildMenu(data.configurations);
   })
     .catch(error => {
      console.error('Error fetching JSON:', error);
   });

   await fetch(apiurl)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+' ('+response.statusText+') returned from '+response.url); };
         return response.json();
      })
       .then((data) => { storeData(data); 
                         fresults( parseStoredData(sessionStorage.getItem('gardeners')) ); 
                       })
       .catch((err) => {
          console.error(err.message);
          faddelem('p',document.body,{innerText:'There was a problem retrieving data. Error '+err.message+'.'});
      })
}

// need to pull resources from a json file to pass into an api
// so needs to be asynchronous. 
const request = async () => {
   asyncGetData();
}

// cache check will be set to yes for sorting of columns and
// and when "gardeners" is cicked on subsequent pages
if( p_cache_check === 'yes' && sessionStorage.getItem('gardeners') ) {
    console.log('found session');
    fresults( parseStoredData(sessionStorage.getItem('gardeners')), );
} else {
    request();  
}
 
</script>

</body>
</html>
