<!DOCTYPE html> 
<html lang="en">  
 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="viewport" content="width=device-width, minimum-scale=1.0" />
<meta name="description" content="Plant Activity Observers" />
<link rel="icon" type="image/png" href="plant-icon-96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="plant-icon-96.svg" />
<link rel="shortcut icon" href="plant-club.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="plant-icon-192.png" />
<meta name="apple-mobile-web-app-title" content="Garden Artists" />
<link rel="manifest" href="plant_club.webmanifest" />
<link rel="stylesheet" type="text/css" href="seed_library.css" />
<script type="text/javascript" src='common_func.js'> </script>
<title>Garden Viewer</title>
</head>

<body>
<script src="https://cdn.jsdelivr.net/gh/stockslager/inat/js/plant_params_v10.js"></script>
<script>
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
let winurlparams = new URLSearchParams(winurlsearchstr.substring(1));
let p_garden     = winurlparams.get('garden') || '';
let p_params     = winurlparams.get('params') || '';
let p_project_id = winurlparams.get('project_id') || '';
let p_plant_name = winurlparams.get('plant_name') || '';
let p_mode       = winurlparams.get('mode' || 'artists');
let p_seed_prj   = winurlparams.get('state' || '');
let p_plant_id   = winurlparams.get('plant_id' || '');
let p_place_id   = '';
let p_user = '';
let state_param = '';
let configuration = '';

if( p_seed_prj ) {
    // the place selected was added to seed_project parameter and needs to be
    // parsed if control is returning from the insects page.
    let prj    = p_seed_prj.split('$')[0];
    let place  = p_seed_prj.split('$')[1];
    let params = p_seed_prj.split('$')[2];
    let user   = p_seed_prj.split('$')[3];
    let garden = p_seed_prj.split('$')[4];
    let mode   = p_seed_prj.split('$')[5];

    if( prj ) {
        winurlparams.delete('project_id');
        winurlparams.append('project_id', prj);
        p_project_id = prj;
    } 
    if( params ) {
        winurlparams.delete('params');
        winurlparams.append('params', params);
        p_params = params;
    }
    if( place ) {
        winurlparams.delete('place_id');
        winurlparams.append('place_id', place);
        p_place_id = place;
    }
    if( mode ) {
        winurlparams.delete('mode');
        winurlparams.append('mode', mode);
        p_mode = mode;
    }
} 
        
// cache check of session storage to make app less expensive to server (cache check, get it!  bwahahaha)
// session storage is only used for sorting of data in columns at this point.
let p_cache_check = winurlparams.get('cache_check') || 'no';  

let configs = '';

let view = winurlparams.get('view') || '';
let activity_data = winurlparams.get('activity_data') || 'local';
winurlparams.delete('activity_data');

function setUpDefaults(configurations) {

   if( configurations.length === 0 ) {
       faddelem('p',document.body,{innerText:'Configuration file ('+p_params+'.json) contains no valid configurations.'});
       faddelem('p',document.body,{innerText:'There are no configurations specified in '+p_params+'.json'});
       faddelem('p',document.body,{innerText:'Please add at least one valid configuration to '+p_params+'.json'});
       throw new Error('No configurations defined.');
   }
 
   for( let i=0; i<configurations.length; i++ ) {
        if( configurations[i].art_project ) {
            configuration = configurations[i];
        }
   }
        
   if( !configuration ) {
       faddelem('p',document.body,{innerText:'An art_project parameter was not specified in '+p_params+'.json.'});
       faddelem('p',document.body,{innerText:'Please modify '+p_params+'.json to include an art_project.'});
       throw new Error('No configurations defined.');
   }

   winurlparams.delete('project_id');
   winurlparams.append('project_id', configuration.art_project);

   // if there's a default place in the configuration,
   // set the p_place_id to the default.
   if( configuration.default_place ) {
       winurlparams.delete('place_id');
       winurlparams.append('place_id', configuration.default_place);
       p_place_id = configuration.default_place;
   }

   // if no user id was passed in and there's a default user in the configuration,
   // set the p_user to the default.
   if( !p_user && configuration.user_id ) {
       winurlparams.delete('user_id');
       winurlparams.append('user_id', configuration.user_id);
       p_user = configuration.user_id;
   }

}

function buildMenu(configs) {
      let menu_string = '';
      let garden_links = '';
      let params = '';
      let choose_plant = 'Choose Plant';

      if( p_params )         { params      += '?params=' + p_params; }   

      menu_string = '<div class="navbar">';

      menu_string += furl(github_root+'plant_list.html'+params+state_param+'&mode='+p_mode, choose_plant);

      if( p_mode.startsWith('pro') ) {
          menu_string += buildHome(furl(github_root+'plant_dashboard.html?params='+p_params,'&#127807;'));
      }
 
      menu_string += '</div>';

      faddelem('p',document.body,{innerHTML:(menu_string)});  
}
 
function fresults(result, places_obj, taxa_obj) {

   if (result) {

      let total_results = result.total_results;
      let per_page = result.per_page;
      let page_curr = result.page;
      let page_max = Math.ceil(total_results/per_page);
      let page_prev = ((page_curr>1)?page_curr-1:null);
      let page_next = ((page_curr<page_max)?page_curr+1:null);

      let all_artists = '<span id="topright"><b>all artists</b></span>';
    
      faddelem('p',document.body,{innerHTML:'project members: '+fcomnum(total_results) + all_artists + '<br />' 
            +'per page: '+fcomnum(per_page) + '<br />'
            +'page: '+fcomnum(page_curr)+' of '+fcomnum(page_max)+'<br />'
            });

      let table = faddelem('table',document.body,{id:'main'});
      let thead = faddelem('thead',table);
      let hrow = faddelem('tr',thead);

      let labels = [
         {innerText:'#'},
         {innerText:'Icon '},
         {innerText:'User' },
         {innerText:'Pieces'  },
         //{innerText:'Obs'  },
      ];
      faddelems('th',hrow,labels);
      
      let tbody = faddelem('tbody',table);
      for (let i=0; i<result.recs.length; i++) {
         let target_url = '';     
         let brow = faddelem('tr',tbody);
         let rec = result.recs[i];
         let lists = '';
         let user_icon = rec.icon || '';
         
         if( user_icon === '' ){
            user_icon += '<div class="npcicon"></div>';
         } else {
            user_icon = '<img class="exp_icon" src="'+user_icon+'" />';
         }

         let plant_param = '';
         let params = '';
         if( p_params )         { params      += '&params=' + p_params; }   

         state_param = ('&state='+p_project_id);
         if( p_place_id )     { state_param += '$'+p_place_id;     } else { state_param += '$'; }
         if( p_params )       { state_param += '$'+p_params;       } else { state_param += '$'; }
         if( rec.user_login ) { state_param += '$'+rec.user_login; } else { state_param += '$'; }
         if( p_garden )       { state_param += '$'+p_garden;       } else { state_param += '$'; }
         if( p_mode )         { state_param += '$'+p_mode;         } else { state_param += '$'; }

         if( p_plant_id )     { plant_param += '&target_id='+p_plant_id; }

         let values = [
            {innerText:i+1},
            {innerHTML:user_icon},
            {innerHTML:furl(root_people+rec.user_login,rec.user_login)},
            {innerHTML:furl(github_root+'plant_grid.html?project_id='+configuration.art_project+'&user_id='+rec.user_login+params+state_param,rec.observation_count )},
         ];
         faddelems('td',brow,values);
      };

      // buttons to go to prev or next page
      let nav = faddelem('div',document.body,{id:'nav'});
      (page_curr<=1)?faddelem('span',nav,{classList:'button_inactive',title:'already on first page',innerHTML:'&laquo'}):faddelem('a',nav,{classList:'button',title:'first page',id:'button_first',innerHTML:'&laquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,1)});
      (page_prev===null)?faddelem('span',nav,{classList:'button_inactive',title:'no previous page',innerHTML:'&#8249'}):faddelem('a',nav,{classList:'button',title:'previous page',id:'button_prev',innerHTML:'&#8249',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_prev)});
      (page_next===null)?faddelem('span',nav,{classList:'button_inactive',title:'no next page',innerHTML:'&#8250'}):faddelem('a',nav,{classList:'button',title:'next page',id:'button_next',innerHTML:'&#8250',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_next)});
      (page_curr>=page_max)?faddelem('span',nav,{classList:'button_inactive',title:'already on last page',innerHTML:'&raquo'}):faddelem('a',nav,{classList:'button',title:'last page',id:'button_last',innerHTML:'&raquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_max)});
   }
   else { faddelem('p',document.body,{innerText:'No results returned.'}); };
};

class Result {
  constructor(total_results, per_page, page, recs) {
    this.total_results = total_results;
    this.per_page = per_page;
    this.page = page;
    this.recs = recs;
  }
}

class Record {
  constructor(count, icon, user_login, species_count, obs_count) {
    this.count = count;
    this.icon = icon;
    this.user_login = user_login;
    this.species_count = species_count;
    this.obs_count = obs_count;
  }
}
  
function storeData(xobj) {
   let results = xobj.results;

   if (results) {
      let record_array = [];
      for( let i=0; i<results.length; i++ ) {
           const record = new Record((i+1), results[i].user.icon, results[i].user.login, results[i].species_count, results[i].observation_count);
           record_array.push(record);
      }
      const result = new Result( xobj.total_results, xobj.per_page, xobj.page, JSON.stringify(record_array) );

      // Serialize the object to JSON string so it can be stored in session
      const result_string = JSON.stringify(result);
      sessionStorage.setItem('artists', result_string);
   }
   else { faddelem('p',document.body,{innerText:'No results returned.'}); };
}

function parseStoredData(artists) {
   // Check if value exists before parsing
   if( artists ) {
       // Parse the string back to an object
       const retrievedRec = JSON.parse(artists);
       retrievedRec.recs = JSON.parse(retrievedRec.recs);
       return retrievedRec;
   } else {
       console.log("No object found in session storage for key 'myObject'");
       throw new Error("No object found in session storage.");
   }
}

async function asyncGetData() {
   console.log('json ' + json_root+p_params);
   await fetch((json_root+p_params+'.json'))
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+' ('+response.statusText+') returned from '+response.url); };
         return response.json();
      })
     .then(data => {
           console.log('setting up defaults...');
           setUpDefaults(data.configurations);
           console.log('building menu...');
           buildMenu(data.configurations);
   })
     .catch(error => {
      console.error('Error setting up defaults or menu:', error);
      throw new Error('Error setting up defaults or menu.');
   });

   let apibase = 'https://api.inaturalist.org/v1/observations/observers';
   let apiurl = apibase+((winurlparams!='')?('?'+winurlparams):'');
   let apirefurl = 'https://api.inaturalist.org/v1/observations/observers';
   let apirefname = 'iNaturalist Observations Observers';
   let apiref = furl(apirefurl,apirefname);

   console.log('apiurl ' + apiurl);
   await fetch(apiurl)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+' ('+response.statusText+') returned from '+response.url); };
         return response.json();
      })
       .then((data) => { storeData(data); 
                         fresults( parseStoredData(sessionStorage.getItem('artists')) ); 
                       })
       .catch((err) => {
          console.error(err.message);
          faddelem('p',document.body,{innerText:'There was a problem retrieving data. Error '+err.message+'.'});
      })
}

// need to pull resources from a json file to pass into an api
// so needs to be asynchronous. 
const request = async () => {
   asyncGetData();
}

// cache check will be set to yes for sorting of columns and
// and when "artists" is cicked on subsequent pages
if( p_cache_check === 'yes' && sessionStorage.getItem('artists') ) {
    console.log('found session');
    fresults( parseStoredData(sessionStorage.getItem('artists')), );
} else {
    request();  
}
 
</script>

</body>
</html>
