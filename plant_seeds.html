<!DOCTYPE html>
<html lang="en">  
 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  
<meta name="viewport" content="width=device-width, minimum-scale=1.0" />
<meta name="description" content="Seeds" />
<link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link rel="shortcut icon" href="favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
<link rel="stylesheet" type="text/css" href="seed_library.css" />
<meta name="apple-mobile-web-app-title" content="Seeds" />
<link rel="manifest" href="site.webmanifest" />
<script type="text/javascript" src='common_func.js'> </script>
<title>Seeds</title>
<style>
   #utf { font-size:1.475em; }
   .clipart { width:18px; height:18px; text-align:center; vertical-align:middle; z-index: 9999; border: 1px solid forestgreen; padding: 15px; border-radius: 50px; }
   .earth { display:flex; align-items:center; font-size:18px; padding-right:10px; }
   .flowericon { padding-left:5%; font-size:14px; white-space: nowrap; font-style:normal; }
</style>

</head>

<body>
<script>
let winurlstr = window.location.href;
let winurlsearchstr = window.location.search;
let winurlexsearchstr = winurlstr.replace(winurlsearchstr,'');
let winurlparams = new URLSearchParams(winurlsearchstr.substring(1));
let p_params       = winurlparams.get('params') || '';
let p_mode         = winurlparams.get('mode') || '';
let opts = '';

// params for api transaction...
let api_params = '';
 
// config fields
let p_plant_prj  = '';

// build param list for url's used in fresults
for (const [key, value] of winurlparams.entries()) { 
  if( key !== 'place_id' && key !== 'place_name' && key !== 'q' && !key.startsWith('field') ) {
      if( opts === '' ){
          opts += "?";
      } else {
          opts += "&";
      }
      opts += key;
      opts += "=";

      if( key === 'page' ){
          opts += '1';
      } else {
          opts += value;
      }
  } 
}   
 
winurlparams.delete('options');
let p_idextra_user_id = winurlparams.get('idextra_user_id')?.split(',') || [];;
winurlparams.delete('idextra_user_id');
let p_photo_curl_filename_prefix = winurlparams.get('photo_curl_filename_prefix')?.split(',') || ['photo_id'];
winurlparams.delete('photo_curl_filename_prefix');

</script> 
<script src="https://cdn.jsdelivr.net/gh/stockslager/inat/library_params_v4.js"></script>
<script src="https://cdn.jsdelivr.net/gh/stockslager/inat/rewild_common_func_v2.js"></script>
<script> 

// these are stored in params.json 
let p_obs_id   = '';
let p_library_name = '';

function setUpDefaults(configurations) {

   if( configurations.length === 0 ) {
       faddelem('p',document.body,{innerText:'Configuration file ('+p_params+'.json) contains no valid configurations.'});
       faddelem('p',document.body,{innerText:'There are no configurations specified in '+p_params+'.json'});
       faddelem('p',document.body,{innerText:'Please add at least one valid configuration to '+p_params+'.json'});
       throw new Error('No configurations defined.');
   }

   if( configurations.length > 1 ) {
       faddelem('p',document.body,{innerText:'Configuration file ('+p_params+'.json) contains contains more than one configuration.'});
       faddelem('p',document.body,{innerText:'Multiple configurations are not yet supported.'});
       faddelem('p',document.body,{innerText:'Please remove all but one configuration in '+p_params+'.json'});
       throw new Error('No configurations defined.');
   }
 
   console.log('found config');
   configuration = configurations[0];

   // if an insect_project wasn't passed in, default to the first configuration in the .json
   if( !configuration ) {
       if( p_garden ) {
           for( let i=0; i<configurations.length; i++ ) {
                if( configurations[i].title.toLowerCase() === p_garden.toLowerCase() ) {
                    configuration = configurations[i];
                }
           }
       }
   }

   // if the configuration is still not found, default to the first one.
   if( !configuration ) {
       configuration = configurations[0];
   }

   if( !configuration.seed_project ) {
       faddelem('p',document.body,{innerText:'A seed_project or default_place must be specified in '+p_params+'.json'});
       throw new Error('A plant_project or default_place must be specified in '+p_params+'.json');
   }

   api_params += ('?project_id='+configuration.seed_project);
   api_params += '&per_page=50';
   api_params += '&order=asc';
   api_params += '&order_by=species_guess';
   api_params += '&iconic_taxa=plantae';
   api_params += '&search_on=tags';

  if( configuration.seed_project === '218728' ) {   // grovedale
      api_params += '&field:seeds available in library?=';
  } else {
      api_params += '&field:availability=';
  }

}

function buildMenu() {

  let menu = '';
  let links = '';

  // availability drop down...
  if( configuration.seed_project === '218728' ) {   // grovedale
      menu += '<div class="navbar">';
  } else {
      menu += '<div class="navbar">';
      links += furl(github_root+'plant_seeds.html'+opts, 'All');
      links += furl(github_root+'plant_seeds.html'+opts+'&field:availability=available now',        'Available Now');      
      links += furl(github_root+'plant_seeds.html'+opts+'&field:availability=available on request', 'Available on Request');  
      links += furl(github_root+'plant_seeds.html'+opts+'&field:availability=coming soon',          'Coming Soon');      
      links += furl(github_root+'plant_seeds.html'+opts+'&field:availability=out of stock',         'Out of Stock');
      menu  += buildDD( field_name, fields_menu );
  }

  if( p_mode.startsWith('pro') ) {
      menu += buildHome(furl(github_root+'plant_dashboard.html?params='+p_params,'&#127807;'));
  }
 
  menu += '</div>';

  return( menu );
} 

function fresults(xobj, places_obj, tags_obj, fields_obj) {
   let results = xobj.results;
   let box_array = [];
 
   if (results) {
      let total_results = xobj.total_results;
      let per_page = xobj.per_page;
      let page_curr = xobj.page;
      let page_max = Math.ceil(total_results/per_page);
      let page_prev = ((page_curr>1)?page_curr-1:null);
      let page_next = ((page_curr<page_max)?page_curr+1:null);
      let labels = [];

      let field_param = '&title=on&field:'+configuration.field_name+'=';

      let lib_title = '';
      let menu = buildMenu(places_obj, tags_obj, fields_obj);

      if( menu ) {
          let map = '<span id="toprightbold"><div style="display:flex; align-items:center;">'+furl(github_root+'plant_map.html'+api_params+'&centerlat=39.10445934350343&centerlng=-84.5196921535475&defaultzoom=9','<span class="earth">&#127758</span>');
          faddelem('p',document.body,{innerHTML:menu});
          lib_title = map+p_library_name+'</div></span>';
      } else {
          faddelem('h2',document.body,{innerText:p_library_name});
      }

      faddelem('p',document.body,{innerHTML:'total observations: '+fcomnum(total_results)+' <br/>'
             +'per page: '+fcomnum(per_page)+'<br />'
             +'page: '+fcomnum(page_curr)+' of '+fcomnum(page_max)+lib_title+'<br />'});  

      labels = [
            {innerText:'#'},
            {innerText:'Image'},
            {innerText:'Name'}, 
            {innerText:' '},
      ];

      let table = faddelem('table',document.body,{id:'main'});                    
      let thead = faddelem('thead',table);
      let hrow = faddelem('tr',thead);
      
      faddelems('th',hrow,labels);
      let tbody = faddelem('tbody',table);

      // may need to revisit this if species_guess is ever null
      results.sort((a, b) => a.species_guess.toLowerCase().localeCompare(b.species_guess.toLowerCase()))
          
      for (let i=0; i<results.length; i++) {
         let rec = results[i];
         let tax_name = '';
         let pref_tax_name = '';
         let tax_photo = '<div class="clipart">&#127807</div>'; 
         let tax_id = '';
         let values = [];
         let taxon = '';

         let brow = faddelem('tr',tbody);

         if( rec.taxon ){
             tax_id = rec.taxon.id;
             tax_name = rec.taxon.name || '';
             pref_tax_name = rec.taxon.preferred_common_name || '';
           
             if( rec.taxon.default_photo ){
                 if( rec.taxon.default_photo.url ){
                     tax_photo = '<img class="icon" src="'+rec.taxon.default_photo.url+'" />';
                 }
             }
         }

         if( tax_id !== '' ){
             taxon = furl(github_root+'plant_seeds_detail.html?project_id='+configuration.seed_project+'&obs_id='+rec.id,'<span style=\"font-size:larger\">'+pref_tax_name.toLowerCase()+'</span><span style=\"font-style:italic\"><br>('+tax_name+')</span>');         
         }

         // if an insect project was specified in params.json show insect observaitons from that donor
         // project rather than from the user_id on the parent plant observation.
         let insect_param = 'project_id='+configuration.insect_project;

         values = [
                  {innerText:i+1},
                  {innerHTML:furl(root_observations+rec.id,'<img class="photo" src="'+((rec.photos&&rec.photos.length>0)?rec.photos[0].url:'')+'" />')},
                  {innerHTML:taxon},
                  {innerHTML:furl(github_root+'bugs_on_plants2.html?'+insect_param+'&seed_project='+configuration.seed_project+'&list=yes&seeds=yes&menu=all&target_name='+pref_tax_name+'&target_id='+rec.taxon.id+field_param+rec.taxon.id,'<span id=\"utf\">&#129419;</span>')},
                  ];

         faddelems('td',brow,values);
      };

      // buttons to go to prev or next page
      let nav = faddelem('div',document.body,{id:'nav'});
      (page_curr<=1)?faddelem('span',nav,{classList:'button_inactive',title:'already on first page',innerHTML:'&laquo'}):faddelem('a',nav,{classList:'button',title:'first page',id:'button_first',innerHTML:'&laquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,1)});
      (page_prev===null)?faddelem('span',nav,{classList:'button_inactive',title:'no previous page',innerHTML:'&#8249'}):faddelem('a',nav,{classList:'button',title:'previous page',id:'button_prev',innerHTML:'&#8249',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_prev)});
      (page_next===null)?faddelem('span',nav,{classList:'button_inactive',title:'no next page',innerHTML:'&#8250'}):faddelem('a',nav,{classList:'button',title:'next page',id:'button_next',innerHTML:'&#8250',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_next)});
      (page_curr>=page_max)?faddelem('span',nav,{classList:'button_inactive',title:'already on last page',innerHTML:'&raquo'}):faddelem('a',nav,{classList:'button',title:'last page',id:'button_last',innerHTML:'&raquo',href:fpageurl(winurlexsearchstr,winurlparams,per_page,page_max)});
   }
   else { faddelem('p',document.body,{innerText:'No results returned.'}); }; 
};

async function asyncGetData() {
   let instructions = '';

   await fetch(p_params+'.json')
     .then(response => response.json())
     .then(data => {
      // Access your data here 
      if( data.configurations ) {
          console.log('setting up defaults...');
          setUpDefaults(data.configurations);
          console.log('building menu...');
          buildMenu();
      }
      console.log(data);
   })
     .catch(error => {
      console.error('Error fetching JSON:', error);
      instructions = 'Error fetching JSON for project.  The project must be configured in params.json.';
   });

   if (winurlsearchstr==='' || (p_project_id === '' && p_user_id === '') ) {
       instructions = 'This page requires a project_id and/or a user_id argument.  Add ?project_id=12345678 to the end of the url.';
   }


   let apirefurl = 'https://api.inaturalist.org/v1/docs/#!/Observations/get_observations';
   let apibase = 'https://api.inaturalist.org/v1/observations';
   let apiurl = apibase+(api_params);

   console.log('api url ' + apiurl);

   if( instructions ) {
       faddelem('p',document.body,{innerText:instructions});
   }
   else {
      await fetch(apiurl)
      .then((response) => {
         if (!response.ok) { throw new Error(response.status+' ('+response.statusText+') returned from '+response.url); };
         return response.json();
      })
      .then((data) => { fresults(data, parseStoredPlaces(sessionStorage.getItem('places')), parseStoredTags(sessionStorage.getItem('tags')), parseStoredFields(sessionStorage.getItem('fields'))); })
      .catch((err) => {
         console.error(err.message);
         faddelem('p',document.body,{innerText:'There was a problem retrieving data. Error '+err.message+'.'});
      });
   };
}

// need to pull resources from a json file to pass into an api
// so needs to be asynchronous. 
const request = async () => {
   asyncGetData();
}

request()   

</script>
</body>

</html>
